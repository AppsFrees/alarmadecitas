<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recordatorio de Citas - Consultorio Dental</title>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-green-500: rgba(34, 197, 94, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --font-family-base: "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background: linear-gradient(135deg, #e8f5f7 0%, #f0fafb 100%);
            color: var(--color-slate-900);
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 28px;
            color: var(--color-teal-500);
            margin-bottom: 6px;
        }

        .subtitle {
            font-size: 14px;
            color: var(--color-slate-500);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .card {
            background: var(--color-white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(33, 128, 141, 0.1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-slate-900);
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-gray-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-teal-500);
            box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--color-teal-500);
            color: var(--color-white);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--color-teal-600);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: var(--color-red-500);
            color: var(--color-white);
            padding: 8px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: var(--color-red-400);
        }

        .btn-success {
            background: var(--color-green-500);
            color: var(--color-white);
            padding: 8px 12px;
            font-size: 12px;
        }

        .appointment-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .appointment-item {
            background: linear-gradient(135deg, #f8fbfc 0%, #e8f5f7 100%);
            border: 2px solid var(--color-teal-500);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .appointment-item:hover {
            box-shadow: 0 4px 12px rgba(33, 128, 141, 0.2);
            transform: translateX(4px);
        }

        .appointment-item.alert {
            border-color: var(--color-orange-500);
            background: linear-gradient(135deg, #fff8f0 0%, #ffe8d1 100%);
        }

        .appointment-item.upcoming {
            border-color: var(--color-red-500);
            background: linear-gradient(135deg, #ffe8e8 0%, #ffd9d9 100%);
        }

        .appointment-info {
            flex: 1;
        }

        .patient-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-slate-900);
            margin-bottom: 4px;
        }

        .patient-details {
            font-size: 13px;
            color: var(--color-slate-500);
            margin-bottom: 6px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 6px;
        }

        .status-next {
            background: var(--color-green-500);
            color: white;
        }

        .status-soon {
            background: var(--color-orange-500);
            color: white;
        }

        .status-alert {
            background: var(--color-red-500);
            color: white;
        }

        .appointment-actions {
            display: flex;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-slate-500);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .timer-section {
            margin-top: 24px;
        }

        .current-time {
            text-align: center;
            font-size: 26px;
            font-weight: 700;
            color: var(--color-teal-500);
            padding: 18px;
            background: linear-gradient(135deg, #f0fafb 0%, #e0f2f4 100%);
            border-radius: 10px;
            margin-bottom: 16px;
            font-family: 'Courier New', monospace;
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            flex: 1;
            min-width: 120px;
            padding: 10px 12px;
            font-size: 12px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--color-white);
            border-left: 4px solid var(--color-teal-500);
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 320px;
        }

        .notification.error {
            border-left-color: var(--color-red-500);
        }

        .notification.success {
            border-left-color: var(--color-green-500);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--color-white);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--color-gray-300);
        }

        .stat-number {
            font-size: 22px;
            font-weight: 700;
            color: var(--color-teal-500);
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-slate-500);
            margin-top: 4px;
        }

        @media (max-width: 576px) {
            .stats {
                grid-template-columns: 1fr;
            }
            h1 { font-size: 24px; }
        }

        .wp-options {
            margin-top: 8px;
            padding: 10px 12px;
            border-radius: 8px;
            background: rgba(33, 128, 141, 0.05);
            border: 1px dashed rgba(33, 128, 141, 0.4);
        }

        .wp-options-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-slate-900);
            margin-bottom: 6px;
        }

        .wp-options-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .wp-options-row label {
            display: flex;
            align-items: center;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 0;
            color: var(--color-slate-500);
            cursor: pointer;
        }

        .wp-options-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            cursor: pointer;
        }

        .wp-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(37, 211, 102, 0.15);
            color: #128c7e;
            border: 1px solid rgba(18, 140, 126, 0.3);
            margin-left: 6px;
        }

        .wp-config-text {
            font-size: 11px;
            color: var(--color-slate-500);
            margin-top: 4px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .checkbox-group input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü¶∑ Recordatorio de Citas</h1>
            <p class="subtitle">Sistema de alarmas para tu consultorio dental</p>
        </header>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCitas">0</div>
                <div class="stat-label">Total de Citas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="citasHoy">0</div>
                <div class="stat-label">Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="proximaCita">--:--</div>
                <div class="stat-label">Pr√≥xima</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: var(--color-teal-500);">Registrar Nueva Cita</h2>
                
                <div class="form-group">
                    <label for="paciente">Nombre del Paciente *</label>
                    <input type="text" id="paciente" placeholder="Ej: Juan P√©rez" required>
                </div>

                <div class="form-group">
                    <label for="telefono">Tel√©fono (con c√≥digo de pa√≠s, sin espacios)</label>
                    <input type="tel" id="telefono" placeholder="Ej: 51999999999">
                </div>

                <div class="form-group">
                    <label for="servicio">Tipo de Servicio</label>
                    <select id="servicio">
                        <option value="Consulta">Consulta</option>
                        <option value="Limpieza">Limpieza</option>
                        <option value="Ortodoncia">Ortodoncia</option>
                        <option value="Resina">Resina</option>
                        <option value="Extracci√≥n">Extracci√≥n</option>
                        <option value="Tratamiento de conducto">Tratamiento de conducto</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fecha">Fecha *</label>
                    <input type="date" id="fecha" required>
                </div>

                <div class="form-group">
                    <label for="hora">Hora *</label>
                    <input type="time" id="hora" required>
                </div>

                <div class="form-group">
                    <label for="notas">Notas</label>
                    <textarea id="notas" rows="2" placeholder="Informaci√≥n adicional"></textarea>
                </div>

                <div class="form-group">
                    <div class="wp-options">
                        <div class="wp-options-title">Recordatorio por WhatsApp al paciente</div>
                        <div class="wp-options-row">
                            <label for="wp1h"><input type="checkbox" id="wp1h"> 1 hora antes</label>
                            <label for="wp2h"><input type="checkbox" id="wp2h"> 2 horas antes</label>
                            <label for="wp4h"><input type="checkbox" id="wp4h"> 4 horas antes</label>
                            <label for="wp6h"><input type="checkbox" id="wp6h"> 6 horas antes</label>
                        </div>
                        <p class="wp-config-text">
                            La app abrir√° autom√°ticamente el chat de WhatsApp con mensaje preescrito.
                        </p>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="agregarCita()">Agregar Cita</button>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 16px; color: var(--color-teal-500);">Control de Tiempo</h2>
                
                <div class="current-time" id="currentTime">--:--:--</div>

                <div class="controls">
                    <button class="btn btn-primary btn-small" onclick="toggleMonitor()">
                        <span id="monitorBtnText">Iniciar Monitor</span>
                    </button>
                    <button class="btn btn-success btn-small" onclick="testAlarm()">Test Audio</button>
                </div>

                <div style="margin-top: 16px;">
                    <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--color-slate-900);">Configuraci√≥n de Alertas</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="alert30min" checked>
                        <label for="alert30min">Alerta 30 min antes</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="alert15min" checked>
                        <label for="alert15min">Alerta 15 min antes</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="alertExacta" checked>
                        <label for="alertExacta">Alerta a la hora exacta</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 16px; color: var(--color-teal-500);">Citas Programadas</h2>
            <div id="appointmentsList" class="appointment-list">
                <div class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <p>No hay citas registradas. Agrega una nueva cita para comenzar.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
        let monitorActive = false;
        let alarmSoundInterval = null;
        let audioContext = null;

        // ‚úÖ Funci√≥n para inicializar AudioContext tras interacci√≥n
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(e => console.warn('Audio resume failed:', e));
            }
        }

        // ‚úÖ Funci√≥n para parsear fecha y hora en zona local (evita errores UTC)
        function parseLocalDateTime(dateStr, timeStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            const [h, min] = timeStr.split(':').map(Number);
            return new Date(y, m - 1, d, h, min);
        }

        // ‚úÖ Funci√≥n para obtener fecha local en formato amigable (sin UTC shift)
        function formatLocalDate(dateStr) {
            const dt = parseLocalDateTime(dateStr, '12:00');
            return dt.toLocaleDateString('es-PE', {
                weekday: 'short',
                day: 'numeric',
                month: 'short'
            });
        }

        // Al cargar: reiniciar flags de alarmas para citas pasadas
        (function initApp() {
            const now = new Date();
            appointments = appointments.map(apt => {
                const aptTime = parseLocalDateTime(apt.fecha, apt.hora);
                if (aptTime < now) {
                    return {
                        ...apt,
                        triggered30: false,
                        triggered15: false,
                        triggeredExacta: false,
                        wpSent1h: false,
                        wpSent2h: false,
                        wpSent4h: false,
                        wpSent6h: false
                    };
                }
                return apt;
            });
            localStorage.setItem('appointments', JSON.stringify(appointments));
            renderAppointments();
            updateStats();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        })();

        function updateCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
        }

        function speakMessage(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            utterance.rate = 1;
            utterance.pitch = 1;
            utterance.volume = 1;
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        function playAlarmSound() {
            initAudio(); // Asegurar contexto de audio

            if (!audioContext) {
                console.warn('AudioContext no disponible.');
                return;
            }

            const now = new Date();
            const frequencies = [800, 600, 800, 600];
            let index = 0;

            const playBeep = () => {
                if (index >= frequencies.length) return;

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = frequencies[index];
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.25, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);

                index++;
            };

            for (let i = 0; i < frequencies.length * 2; i++) {
                setTimeout(playBeep, i * 250);
            }
        }

        function triggerAlarm(appointment, type) {
            const timeTypes = {
                'alert30': '30 minutos antes',
                'alert15': '15 minutos antes',
                'alertExacta': 'en este momento'
            };

            playAlarmSound();

            const message = `üîî ¬°Atenci√≥n! Cita con ${appointment.paciente} para ${appointment.servicio}, ${timeTypes[type]}.`;
            setTimeout(() => speakMessage(message), 500);

            showNotification(`‚è∞ ${message}`, 'success');
        }

        function buildWhatsAppMessage(appointment) {
            const fechaLocal = formatLocalDate(appointment.fecha);
            let msg = `Hola ${appointment.paciente}, te recordamos tu cita de *${appointment.servicio}* el *${fechaLocal}* a las *${appointment.hora}* en el consultorio dental.`;
            if (appointment.notas) {
                msg += ` Notas: _${appointment.notas}_.`;
            }
            msg += ' Por favor responde para confirmar tu asistencia. Gracias.';
            return msg;
        }

        function openWhatsApp(appointment, hoursBefore) {
            if (!appointment.telefono) {
                showNotification(`No se puede abrir WhatsApp: falta tel√©fono para ${appointment.paciente}`, 'error');
                return;
            }

            let phone = appointment.telefono.replace(/\D/g, '');
            if (phone.length < 8 || phone.length > 15) {
                showNotification(`Tel√©fono inv√°lido: "${appointment.telefono}". Debe tener 8-15 d√≠gitos.`, 'error');
                return;
            }

            const msg = buildWhatsAppMessage(appointment);
            const encodedMsg = encodeURIComponent(msg);
            const url = `https://wa.me/${phone}?text=${encodedMsg}`; // ‚úÖ Corregido: sin espacios

            window.open(url, '_blank');
            showNotification(`‚úÖ WhatsApp (${hoursBefore}h antes) abierto para ${appointment.paciente}`, 'success');
        }

        function agregarCita() {
            const paciente = document.getElementById('paciente').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const servicio = document.getElementById('servicio').value;
            const fecha = document.getElementById('fecha').value;
            const hora = document.getElementById('hora').value;
            const notas = document.getElementById('notas').value.trim();

            const wp1h = document.getElementById('wp1h').checked;
            const wp2h = document.getElementById('wp2h').checked;
            const wp4h = document.getElementById('wp4h').checked;
            const wp6h = document.getElementById('wp6h').checked;

            if (!paciente || !fecha || !hora) {
                showNotification('Por favor completa los campos requeridos: Nombre, Fecha y Hora.', 'error');
                return;
            }

            const appointment = {
                id: Date.now(),
                paciente,
                telefono,
                servicio,
                fecha,
                hora,
                notas,
                wp1h,
                wp2h,
                wp4h,
                wp6h,
                triggered30: false,
                triggered15: false,
                triggeredExacta: false,
                wpSent1h: false,
                wpSent2h: false,
                wpSent4h: false,
                wpSent6h: false
            };

            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));

            renderAppointments();
            showNotification(`‚úÖ Cita de ${paciente} registrada`, 'success');

            // Limpiar formulario
            document.getElementById('paciente').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('servicio').value = 'Consulta';
            document.getElementById('fecha').value = '';
            document.getElementById('hora').value = '';
            document.getElementById('notas').value = '';
            ['wp1h', 'wp2h', 'wp4h', 'wp6h'].forEach(id => document.getElementById(id).checked = false);
        }

        function eliminarCita(id) {
            appointments = appointments.filter(a => a.id !== id);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            renderAppointments();
            showNotification('Cita eliminada', 'success');
        }

        function getWhatsappConfigText(apt) {
            const sel = [];
            if (apt.wp1h) sel.push('1h');
            if (apt.wp2h) sel.push('2h');
            if (apt.wp4h) sel.push('4h');
            if (apt.wp6h) sel.push('6h');
            return sel.length ? `WA: ${sel.join(' / ')}` : '';
        }

        function renderAppointments() {
            const now = new Date();
            const sorted = [...appointments].sort((a, b) => {
                const ta = parseLocalDateTime(a.fecha, a.hora);
                const tb = parseLocalDateTime(b.fecha, b.hora);
                return ta - tb;
            });

            const list = document.getElementById('appointmentsList');

            if (sorted.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <p>No hay citas registradas. Agrega una nueva cita para comenzar.</p>
                    </div>
                `;
                updateStats();
                return;
            }

            list.innerHTML = sorted.map(apt => {
                const aptTime = parseLocalDateTime(apt.fecha, apt.hora);
                const diff = aptTime - now;
                const minDiff = Math.floor(diff / 60000);

                let statusText, statusClass, statusType;

                if (diff < 0) {
                    statusText = '‚úì Completada';
                    statusType = 'status-next';
                } else if (minDiff <= 15) {
                    statusText = '‚ö†Ô∏è Inminente';
                    statusType = 'status-alert';
                    statusClass = 'upcoming';
                } else if (minDiff <= 30) {
                    statusText = 'üîî En breve';
                    statusType = 'status-soon';
                    statusClass = 'alert';
                } else {
                    statusText = 'üìÖ Programada';
                    statusType = 'status-next';
                }

                const wpText = getWhatsappConfigText(apt);
                const fechaLocal = formatLocalDate(apt.fecha);

                return `
                    <div class="appointment-item ${statusClass || ''}">
                        <div class="appointment-info">
                            <div class="patient-name">
                                ${apt.paciente}
                                ${wpText ? `<span class="wp-badge">${wpText}</span>` : ''}
                            </div>
                            <div class="patient-details">
                                üìû ${apt.telefono || '‚Äî'} | üè• ${apt.servicio}
                            </div>
                            <div class="patient-details">
                                üìÖ ${fechaLocal} - ‚è∞ ${apt.hora}
                            </div>
                            ${apt.notas ? `<div class="patient-details">üìù ${apt.notas}</div>` : ''}
                            <span class="status-badge ${statusType}">${statusText}</span>
                        </div>
                        <button class="btn btn-danger" onclick="eliminarCita(${apt.id})">Eliminar</button>
                    </div>
                `;
            }).join('');

            updateStats();
        }

        function updateStats() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];

            document.getElementById('totalCitas').textContent = appointments.length;
            document.getElementById('citasHoy').textContent = appointments.filter(a => a.fecha === today).length;

            const next = appointments
                .filter(a => parseLocalDateTime(a.fecha, a.hora) > now)
                .sort((a, b) => parseLocalDateTime(a.fecha, a.hora) - parseLocalDateTime(b.fecha, b.hora))
                .shift();

            document.getElementById('proximaCita').textContent = next ? next.hora : '--:--';
        }

        function checkAlarms() {
            const now = new Date();

            appointments.forEach(apt => {
                const aptTime = parseLocalDateTime(apt.fecha, apt.hora);
                const diffMs = aptTime - now;
                const minutesDiff = Math.floor(diffMs / 60000);
                const secondsDiff = Math.floor((diffMs / 1000) % 60);

                // WhatsApp (solo en segundos = 0 para evitar repeticiones)
                if (secondsDiff === 0) {
                    if (apt.wp6h && minutesDiff === 360 && !apt.wpSent6h) {
                        openWhatsApp(apt, 6);
                        apt.wpSent6h = true;
                    }
                    if (apt.wp4h && minutesDiff === 240 && !apt.wpSent4h) {
                        openWhatsApp(apt, 4);
                        apt.wpSent4h = true;
                    }
                    if (apt.wp2h && minutesDiff === 120 && !apt.wpSent2h) {
                        openWhatsApp(apt, 2);
                        apt.wpSent2h = true;
                    }
                    if (apt.wp1h && minutesDiff === 60 && !apt.wpSent1h) {
                        openWhatsApp(apt, 1);
                        apt.wpSent1h = true;
                    }
                }

                // Alarmas locales
                if (secondsDiff === 0) {
                    if (document.getElementById('alert30min').checked && minutesDiff === 30 && !apt.triggered30) {
                        triggerAlarm(apt, 'alert30');
                        apt.triggered30 = true;
                    }
                    if (document.getElementById('alert15min').checked && minutesDiff === 15 && !apt.triggered15) {
                        triggerAlarm(apt, 'alert15');
                        apt.triggered15 = true;
                    }
                    if (document.getElementById('alertExacta').checked && minutesDiff === 0 && !apt.triggeredExacta) {
                        triggerAlarm(apt, 'alertExacta');
                        apt.triggeredExacta = true;
                    }
                }
            });

            localStorage.setItem('appointments', JSON.stringify(appointments));
        }

        function toggleMonitor() {
            initAudio();
            monitorActive = !monitorActive;

            const btn = document.getElementById('monitorBtnText');
            clearInterval(alarmSoundInterval); // ‚úÖ Evita duplicados

            if (monitorActive) {
                btn.textContent = 'Monitor Activo ‚úì';
                alarmSoundInterval = setInterval(() => {
                    updateCurrentTime();
                    checkAlarms();
                }, 1000);
                showNotification('‚úÖ Monitor activado. Mant√©n esta pesta√±a abierta para recibir alertas.', 'success');
            } else {
                btn.textContent = 'Iniciar Monitor';
                showNotification('‚èπÔ∏è Monitor desactivado.', 'success');
            }
        }

        function testAlarm() {
            initAudio();
            playAlarmSound();
            setTimeout(() => speakMessage('Sistema de alertas funcionando correctamente.'), 500);
            showNotification('üîä Prueba de alarma ejecutada', 'success');
        }

        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }
    </script>
</body>
</html>
